# Download benchmark by dvassallo/s3-benchmark

Measure S3 downloading performance using different thread counts and object sizes

[dvassallo/s3-benchmark](https://github.com/dvassallo/s3-benchmark)

## Prepare install utilities
```bash
# Set the AWS credential
aws configure

# Install Golang and s3-benchmark utility
sudo yum install -y go
echo 'export GOPATH=/home/ec2-user/go' >> ~/.bash_profile
curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
echo 'export PATH=/home/ec2-user/go/bin:$PATH' >> ~/.bash_profile
source ~/.bash_profile
cd ${GOPATH}/src
git clone https://github.com/dvassallo/s3-benchmark

cd ${GOPATH}/src/s3-benchmark
```

## Modify main.go increase the timeout (default is 180 seconds)
Due to data transfer via public Internet is not stable, so need increase default 180 seconds timeout
1. Modify the code
```go
// set a 3-minute timeout for all S3 calls, including downloading the body
    cfg.HTTPClient = &http.Client{
        Timeout: time.Second * 1800,
    }
```
2. build utiltiy
```bash
# You may need change the import "github.com/schollz/progressbar/v2" to "github.com/schollz/progressbar" to avoid dep error
dep ensure

# Change back import to "github.com/schollz/progressbar/v2" if you change it to "github.com/schollz/progressbar"
./go-build-all
```

## Testing for downloading from Hongkong region S3 bucket with m4.16xlarge EC2

**Important Note: The testing data transfer is Internet based, the speed and throuhput can be different consider the connection stablization.**

**Important Note: The utility multiple threads setting only up to 16, so the performance will be impact.**

1. The payload from 16 KiB to 1024 MiB and the multiple threads as 16 (max value)
```bash
# -payloads-max 15 == 16MiB, -payloads-max 21 == 1024MiB
build/linux-amd64/s3-benchmark -region ap-east-1 -bucket-name molex-mess-migration-hk -threads-min 16 -threads-max 16 -payloads-min 5 -payloads-max 21 -samples 100 -upload-csv m4-16xlarge

# capture the number of open connections
# The same as -threads-max
lsof -i tcp:443 | tail -n +2 | wc -l
16

# CPU load
# The CPU load is less than 10%
mpstat -P ALL 10
```


2. Sample Result
```bash
--- SETUP --------------------------------------------------------------------------------------------------------------------

Uploading 16 KB objects
 100% |████████████████████████████████████████|  [5s:0s]
Uploading 32 KB objects
 100% |████████████████████████████████████████|  [5s:0s]
Uploading 64 KB objects
 100% |████████████████████████████████████████|  [6s:0s]
Uploading 128 KB objects
 100% |████████████████████████████████████████|  [8s:0s]
Uploading 256 KB objects
 100% |████████████████████████████████████████|  [7s:0s]
Uploading 512 KB objects
 100% |████████████████████████████████████████|  [7s:0s]
Uploading 1 MB objects
 100% |████████████████████████████████████████|  [8s:0s]
Uploading 2 MB objects
 100% |████████████████████████████████████████|  [9s:0s]
Uploading 4 MB objects
 100% |████████████████████████████████████████|  [11s:0s]
Uploading 8 MB objects
 100% |████████████████████████████████████████|  [14s:0s]
Uploading 16 MB objects
 100% |████████████████████████████████████████|  [16s:0s]

--- BENCHMARK ----------------------------------------------------------------------------------------------------------------

Download performance with 16 KB objects (m4.16xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       0.9 MB/s |  258   120   125   192   212   651   876   877 |  266   120   128   196   235   660   876   877 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 32 KB objects (m4.16xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       1.2 MB/s |  222   118   126   135   194   513   765   773 |  268   119   128   136   200   627  1135  1376 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 64 KB objects (m4.16xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       2.8 MB/s |  231   116   127   183   207   511   778   782 |  340   117   128   203   405   756  1136  1141 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 128 KB objects (m4.16xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       5.3 MB/s |  215   124   128   134   195   506   789   805 |  333   125   130   200   388   759  1255  1624 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 256 KB objects (m4.16xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       9.5 MB/s |  228   118   127   175   200   520   756   856 |  363   119   129   194   404   890  1512  1660 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 512 KB objects (m4.16xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       7.5 MB/s |  223   118   122   134   160   606   824   853 |  686   121   129   139   279  2240  5660  6670 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 1 MB objects (m4.16xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |      10.1 MB/s |  223   123   125   128   191   630   804   877 |  751   128   132   139   415  1869  5696  9916 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 2 MB objects (m4.16xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       8.2 MB/s |  239   122   126   131   142   787   948   959 | 1752   241   248   257   271  2818 20911 24248 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 4 MB objects (m4.16xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |      12.4 MB/s |  262   123   124   126   141  1003  1128  1141 | 3626   364   367   382   828 15867 32008 32299 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 8 MB objects (m4.16xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |      11.6 MB/s |  239   121   125   127   144   787  1016  1026 | 4391   693   709   724   740  5733 47268 69064 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 16 MB objects (m4.16xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       8.5 MB/s |  255   117   126   133   145   874  1090  1092 |10335  1227  1311  1378  1420  2914 152412 188341 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

CSV results uploaded to s3://molex-mess-migration-hk/results/m4-16xlarge-m4.16xlarge

--- CLEANUP ------------------------------------------------------------------------------------------------------------------

Deleting any objects uploaded from i-063b4b4bce0eaccfe
 100% |████████████████████████████████████████|  [3m8s:0s]
```

[m4-16xlarge-m4.16xlarge result](result/m4-16xlarge-m4.16xlarge)

## Testing for downloading from Hongkong region S3 bucket with m5.24xlarge EC2

**Important Note: The testing data transfer is Internet based, the speed and throuhput can be different consider the connection stablization.**

1. Testing for HK region S3 bucket with m5.24xlarge
```bash
# -payloads-max 15 == 16MiB, -payloads-max 21 == 1024MiB
build/linux-amd64/s3-benchmark -region ap-east-1 -bucket-name molex-mess-migration-hk -threads-min 16 -threads-max 16 -payloads-min 5 -payloads-max 16 -samples 100 -upload-csv m5-24xlarge

# capture the number of open connections
# The same as -threads-max
lsof -i tcp:443 | tail -n +2 | wc -l
16

# CPU load
# The CPU load is less than 10%
mpstat -P ALL 10
```

2. Sample result
```bash
--- SETUP --------------------------------------------------------------------------------------------------------------------

Uploading 16 KB objects
 100% |████████████████████████████████████████|  [2s:0s]
Uploading 32 KB objects
 100% |████████████████████████████████████████|  [2s:0s]
Uploading 64 KB objects
 100% |████████████████████████████████████████|  [3s:0s]
Uploading 128 KB objects
 100% |████████████████████████████████████████|  [2s:0s]
Uploading 256 KB objects
 100% |████████████████████████████████████████|  [3s:0s]
Uploading 512 KB objects
 100% |████████████████████████████████████████|  [3s:0s]
Uploading 1 MB objects
 100% |████████████████████████████████████████|  [3s:0s]
Uploading 2 MB objects
 100% |████████████████████████████████████████|  [2s:0s]
Uploading 4 MB objects
 100% |████████████████████████████████████████|  [2s:0s]
Uploading 8 MB objects
 100% |████████████████████████████████████████|  [2s:0s]
Uploading 16 MB objects
 100% |████████████████████████████████████████|  [2s:0s]

--- BENCHMARK ----------------------------------------------------------------------------------------------------------------

Download performance with 16 KB objects (m5.24xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       0.5 MB/s |  298   123   160   184   211   863  1014  1025 |  379   123   166   201   398   919  1297  1545 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 32 KB objects (m5.24xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       0.8 MB/s |  295   152   184   197   216   799   903  1090 |  456   153   189   362   582   995  1803  1834 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 64 KB objects (m5.24xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       1.4 MB/s |  273   129   152   169   193   848   965  1145 |  577   130   172   326   876  1222  1844  2346 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 128 KB objects (m5.24xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       1.6 MB/s |  243   129   150   167   196   604   747   892 |  949   256   427   701  1230  1736  3369  3716 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 256 KB objects (m5.24xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       2.2 MB/s |  326   136   174   194   232  1053  1193  1197 | 1240   144   198   407  1964  2993  5440  5949 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 512 KB objects (m5.24xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       0.6 MB/s |  405   155   217   252   295  1157  1386  1392 |11920   623  9106 12090 15239 19047 23103 23860 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 1 MB objects (m5.24xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       0.7 MB/s |  408   124   191   224   325  1104  1561  2091 |19668  1102  5802 21297 28241 34434 40813 41905 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 2 MB objects (m5.24xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       1.6 MB/s |  326   129   155   171   255   887  1497  2398 |16506  1233  6795 10123 24829 39009 57325 63483 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 4 MB objects (m5.24xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       0.9 MB/s |  475   133   193   258   568  1153  1791  2140 |58506   486 45244 62636 74100 96647 132824 138810 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 8 MB objects (m5.24xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       1.2 MB/s |  532   136   169   265   966  1221  2071  2182 |87101  1258 12841 103653 130201 176039 231784 233497 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

Download performance with 16 MB objects (m5.24xlarge)
                           +-------------------------------------------------------------------------------------------------+
                           |            Time to First Byte (ms)             |            Time to Last Byte (ms)              |
+---------+----------------+------------------------------------------------+------------------------------------------------+
| Threads |     Throughput |  avg   min   p25   p50   p75   p90   p99   max |  avg   min   p25   p50   p75   p90   p99   max |
+---------+----------------+------------------------------------------------+------------------------------------------------+
|      16 |       1.3 MB/s |  562   132   153   258   995  1383  1947  2182 |165352  4820 22786 173149 256923 355458 442540 452805 |
+---------+----------------+------------------------------------------------+------------------------------------------------+

CSV results uploaded to s3://molex-mess-migration-hk/results/m5-24xlarge-m5.24xlarge

--- CLEANUP ------------------------------------------------------------------------------------------------------------------

Deleting any objects uploaded from i-0d8cdb5cc19270237
 100% |████████████████████████████████████████|  [3m38s:0s]
 ```

[m5-24xlarge-m5.24xlarge result](result/m5-24xlarge-m5.24xlarge)



## Testing S3 to EC2 downloading performance within same region

[dvassallo/s3-benchmark](https://github.com/dvassallo/s3-benchmark) has been ran the benchmark on all current generation EC2 instance types as of 2019-04-02. The an interactive spreadsheet result that you can [download here](https://github.com/dvassallo/s3-benchmark/blob/master/Analysis%20of%20S3%20Performance%20from%20EC2.xlsx?raw=true). 

**Important Note: The utility multiple threads setting only up to 16, so the performance will be impact.**